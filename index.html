<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Budget Master Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">

    <!-- CSS (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Force display for critical UI elements */
        #mobile-nav { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50; background: white; border-top: 1px solid #e2e8f0; padding-bottom: env(safe-area-inset-bottom); display: flex !important; }
        #desktop-sidebar { display: none; }
        @media (min-width: 768px) {
            #mobile-nav { display: none !important; }
            #desktop-sidebar { display: flex !important; }
        }
        /* FAB Button fixed position */
        .fab-btn { position: fixed; bottom: 90px; right: 20px; z-index: 60; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        @media (min-width: 768px) { .fab-btn { display: none !important; } }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 z-[1000] bg-white flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="loader mb-4"></div>
        <p class="text-slate-500 text-sm font-medium">Chargement...</p>
        <button onclick="App.logout()" class="mt-8 text-xs text-red-400 underline cursor-pointer">Forcer DÃ©connexion</button>
    </div>

    <!-- Main Container -->
    <div class="flex h-full w-full">
        
        <!-- Desktop Sidebar -->
        <aside id="desktop-sidebar" class="hidden w-64 bg-white border-r border-slate-200 flex-col">
            <div class="p-6 flex items-center gap-3 text-blue-600 font-bold text-xl border-b border-slate-50">
                <span class="text-2xl">Wallet</span> Budget Pro
            </div>
            <nav class="flex-1 p-4 space-y-2" id="desktop-menu"></nav>
            <div class="p-4 border-t border-slate-100">
                <div id="user-email" class="px-2 text-xs font-bold text-slate-400 mb-2 truncate"></div>
                <button onclick="App.logout()" class="w-full flex items-center justify-center gap-2 text-sm text-red-500 font-bold py-3 rounded-xl border border-red-100 hover:bg-red-50 transition-colors">DÃ©connexion</button>
            </div>
        </aside>

        <!-- Main View -->
        <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50">
            <!-- Mobile Header -->
            <div class="md:hidden bg-white px-5 py-4 flex justify-between items-center border-b border-slate-100 pt-safe z-10 shadow-sm">
                <div class="flex items-center gap-2 text-blue-600 font-bold text-lg">Budget Pro</div>
                <div class="flex gap-4">
                    <button onclick="App.openModal('feedback')" class="text-slate-400">ðŸ’¡</button>
                    <button onclick="App.logout()" class="text-red-400">ðŸšª</button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div id="content" class="flex-1 overflow-y-auto p-4 md:p-10 pb-28 md:pb-10 space-y-6">
                <!-- Content injected here -->
            </div>

            <!-- Mobile FAB -->
            <button onclick="App.openModal('transaction')" class="fab-btn md:hidden w-14 h-14 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl active:scale-90 transition-transform">+</button>

            <!-- Mobile Bottom Nav -->
            <div id="mobile-nav" class="justify-around items-center">
                <!-- Nav injected here -->
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modals"></div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc, getDoc, writeBatch, query, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION
        const CONFIG = {
            apiKey: "AIzaSyArI0_rQUsVKpjXfup9F_JDXY8NKT8LFXc",
            authDomain: "qd-budget.firebaseapp.com",
            projectId: "qd-budget",
            storageBucket: "qd-budget.firebasestorage.app",
            messagingSenderId: "449759615644",
            appId: "1:449759615644:web:18ab3fae6255071822eb59"
        };
        
        // --- GLOBAL STATE ---
        const State = {
            user: null,
            view: 'home',
            month: new Date().toISOString().slice(0, 7),
            transactions: [],
            invoices: [],
            plan: { revenus: [], fixes: [], epargne: [], beneficiaries: [], variableBudgets: [] },
            categories: {
                variable: ['Alimentation', 'Resto/Sorties', 'Shopping', 'Carburant/Transport', 'SantÃ©', 'Loisirs', 'Cadeaux', 'Maison'],
                fixe: ['Loyer/PrÃªt', 'Ã‰nergie', 'Eau', 'Internet/Tel', 'Assurances', 'Taxes', 'Abonnements', 'Emprunts'],
                revenu: ['Salaire', 'Dividendes', 'Remboursement', 'Vente', 'Flexi-job', 'Autre'],
                epargne: ['Virement vers Ã‰pargne', 'Investissements', 'Vacances'],
                virement: ['Ã‰pargne > Courant', 'Courant > Ã‰pargne', 'Courant > Cash (Retrait)', 'Cash > Courant (DÃ©pÃ´t)']
            }
        };

        // --- INIT FIREBASE ---
        const app = initializeApp(CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);
        try { enableIndexedDbPersistence(db); } catch(e) {}

        // --- HELPER FUNCTIONS ---
        const formatMoney = (amount) => new Intl.NumberFormat('fr-BE', { style: 'currency', currency: 'EUR' }).format(amount);
        
        // --- APP LOGIC ---
        const App = {
            init: () => {
                onAuthStateChanged(auth, (user) => {
                    document.getElementById('loader').classList.add('hidden');
                    State.user = user;
                    
                    if (user) {
                        document.getElementById('user-email').innerText = user.email;
                        App.loadData();
                        App.renderNav(); // Build menus immediately
                    } else {
                        App.renderLogin();
                    }
                });
            },

            loadData: () => {
                const uid = State.user.uid;
                
                // Real-time listeners
                onSnapshot(collection(db, 'artifacts', 'budget-app', 'users', uid, 'transactions'), snap => {
                    State.transactions = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(b.date) - new Date(a.date));
                    App.renderView(); // Refresh view
                    // Check Onboarding
                    if(State.transactions.length === 0) setTimeout(() => App.openModal('onboarding-1'), 1000);
                });

                onSnapshot(collection(db, 'artifacts', 'budget-app', 'users', uid, 'invoices'), snap => {
                    State.invoices = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
                    App.renderView();
                });

                onSnapshot(doc(db, 'artifacts', 'budget-app', 'users', uid, 'settings', 'budget_plan'), snap => {
                    if(snap.exists()) State.plan = snap.data();
                    App.renderView();
                });
            },

            logout: () => signOut(auth),
            
            login: async (email, pass, isReg) => {
                try {
                    if(isReg) await createUserWithEmailAndPassword(auth, email, pass);
                    else await signInWithEmailAndPassword(auth, email, pass);
                } catch(e) { alert("Erreur: " + e.message); }
            },

            setView: (viewName) => {
                State.view = viewName;
                App.renderView();
                App.renderNav(); // Update active state
            },

            // --- UI RENDERERS ---
            renderNav: () => {
                const items = [
                    {id:'home', label:'Accueil', icon:'ðŸ '},
                    {id:'list', label:'Journal', icon:'ðŸ“'},
                    {id:'invoices', label:'Factures', icon:'ðŸ“„'},
                    {id:'chart', label:'Analyses', icon:'ðŸ“Š'},
                    {id:'settings', label:'Plan', icon:'âš™ï¸'}
                ];

                // Desktop
                const dMenu = document.getElementById('desktop-menu');
                dMenu.innerHTML = items.map(i => `
                    <button onclick="window.App.setView('${i.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all ${State.view===i.id ? 'bg-blue-50 text-blue-600' : 'text-slate-500 hover:bg-slate-50'}">
                        <span class="text-lg">${i.icon}</span> ${i.label}
                    </button>
                `).join('');

                // Mobile
                const mMenu = document.getElementById('mobile-nav');
                mMenu.innerHTML = items.map(i => `
                    <button onclick="window.App.setView('${i.id}')" class="p-2 flex flex-col items-center gap-1 flex-1 transition-colors ${State.view===i.id ? 'text-blue-600' : 'text-slate-400'}">
                        <span class="text-xl">${i.icon}</span>
                        <span class="text-[10px] font-bold">${i.label}</span>
                    </button>
                `).join('');
            },

            renderLogin: () => {
                document.getElementById('content').innerHTML = `
                    <div class="h-full flex items-center justify-center">
                        <div class="bg-white w-full max-w-sm p-8 rounded-2xl shadow-xl">
                            <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">Budget Master</h1>
                            <form onsubmit="event.preventDefault(); window.App.login(this.email.value, this.pass.value, false)" class="space-y-4">
                                <input name="email" type="email" class="w-full border p-4 rounded-xl bg-slate-50" placeholder="Email" required>
                                <input name="pass" type="password" class="w-full border p-4 rounded-xl bg-slate-50" placeholder="Mot de passe" required>
                                <button class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg">Connexion</button>
                                <button type="button" onclick="window.App.login(this.form.email.value, this.form.pass.value, true)" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl">CrÃ©er un compte</button>
                            </form>
                        </div>
                    </div>
                `;
                // Hide navs on login
                document.getElementById('mobile-nav').classList.add('hidden');
                document.getElementById('desktop-sidebar').classList.add('hidden');
                document.querySelector('.fab-btn').classList.add('hidden');
            },

            renderView: () => {
                if(!State.user) return;
                
                // Restore Navs
                document.getElementById('mobile-nav').classList.remove('hidden');
                document.getElementById('desktop-sidebar').classList.remove('hidden');
                // FAB only on home
                if(State.view === 'home') document.querySelector('.fab-btn').classList.remove('hidden');
                else document.querySelector('.fab-btn').classList.add('hidden');

                const content = document.getElementById('content');
                const stats = App.computeStats();

                if (State.view === 'home') {
                    content.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <div><p class="text-slate-500 text-xs font-bold uppercase">Patrimoine</p><h2 class="text-3xl font-bold text-slate-800">${formatMoney(stats.patrim)}</h2></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl p-6 text-white shadow-lg">
                                <p class="text-blue-100 text-sm mb-1">Compte Courant</p><p class="text-3xl font-bold">${formatMoney(stats.sc)}</p>
                                <div class="mt-4 pt-4 border-t border-white/20 text-xs flex justify-between"><span>Fin mois est.</span><span class="font-bold text-lg">${formatMoney(stats.proj)}</span></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100"><p class="text-slate-400 text-xs font-bold uppercase">Ã‰pargne</p><p class="text-xl font-bold text-slate-800 truncate">${formatMoney(stats.se)}</p></div>
                                <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100"><p class="text-slate-400 text-xs font-bold uppercase">Cash</p><p class="text-xl font-bold text-slate-800 truncate">${formatMoney(stats.cash)}</p></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start mb-4">
                                <div><p class="text-xs text-slate-400 font-bold uppercase">Reste Ã  dÃ©penser</p><h2 class="text-3xl font-bold ${stats.resteVar<0?'text-red-500':'text-slate-800'}">${formatMoney(stats.resteVar)}</h2></div>
                                <div class="text-right"><p class="text-xs text-slate-400">Budget</p><p class="font-bold text-slate-600">${formatMoney(stats.budgetVar)}</p></div>
                            </div>
                            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden mb-6"><div class="h-full ${stats.resteVar<0?'bg-red-500':'bg-blue-500'}" style="width:${stats.budgetVar>0 ? Math.min((stats.mStats.variable/stats.budgetVar)*100, 100) : 0}%"></div></div>
                            <div class="grid grid-cols-3 gap-2 text-center text-xs">
                                <div class="bg-slate-50 p-2 rounded"><span class="block text-slate-400 uppercase">Revenus</span><span class="font-bold text-green-600">+${stats.mStats.revenu}</span></div>
                                <div class="bg-slate-50 p-2 rounded"><span class="block text-slate-400 uppercase">Fixes</span><span class="font-bold text-slate-700">-${stats.mStats.fixe}</span></div>
                                <div class="bg-slate-50 p-2 rounded"><span class="block text-slate-400 uppercase">Variable</span><span class="font-bold text-blue-600">-${stats.mStats.variable}</span></div>
                            </div>
                        </div>
                    `;
                } else if (State.view === 'list') {
                     content.innerHTML = `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4 flex justify-between items-center">
                            <h2 class="font-bold text-lg">Journal</h2>
                            <button onclick="window.App.genMonthly()" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-lg font-bold">âš¡ GÃ©nÃ©rer Fixes</button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            ${State.transactions.length === 0 ? '<div class="p-8 text-center text-slate-400 text-sm">Aucune opÃ©ration</div>' : 
                            State.transactions.map(t => `
                                <div class="p-4 border-b last:border-0 flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-sm text-slate-800">${t.name}</div>
                                        <div class="text-xs text-slate-400">${new Date(t.date).toLocaleDateString()} â€¢ ${t.category}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-sm ${t.type==='revenu'||t.type==='initial'?'text-green-600':t.type==='epargne'?'text-amber-600':'text-slate-800'}">${t.type==='revenu'||t.type==='initial'?'+':'-'}${formatMoney(parseFloat(t.amount))}</div>
                                        <button onclick="window.App.delTx('${t.id}')" class="text-[10px] text-red-300">Supprimer</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                     `;
                } else if (State.view === 'invoices') {
                    content.innerHTML = `
                         <div class="flex justify-between items-center mb-6"><h2 class="font-bold text-xl">Factures</h2><button onclick="window.App.openModal('add-invoice')" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex gap-1 items-center">+ Nouvelle</button></div>
                         <div class="space-y-6">
                            ${State.invoices.filter(i=>i.status==='pending').map(inv => `
                                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                                    <div><p class="font-bold text-slate-800">${inv.sender}</p><p class="text-xs text-red-500 font-bold">Ã‰chÃ©ance : ${new Date(inv.dueDate).toLocaleDateString()}</p></div>
                                    <div class="text-right"><p class="font-bold text-lg">${inv.amount}â‚¬</p><button onclick='window.App.openModal("pay-invoice", ${JSON.stringify(inv)})' class="bg-blue-600 text-white text-xs px-3 py-1 rounded-lg">Payer</button></div>
                                </div>
                            `).join('') || '<div class="text-center text-slate-400 text-sm">Rien Ã  payer ðŸŽ‰</div>'}
                         </div>
                    `;
                } else if (State.view === 'settings') {
                    content.innerHTML = `
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h3 class="font-bold text-sm uppercase text-slate-400 mb-4">Planification Mensuelle</h3>
                                ${['revenus', 'fixes', 'epargne'].map(sec => `
                                    <div class="mb-4">
                                        <div class="flex justify-between items-center mb-2"><h4 class="font-bold capitalize text-sm">${sec}</h4><button onclick="window.App.openModal('plan-item', '${sec}')" class="bg-slate-100 w-6 h-6 rounded flex items-center justify-center text-slate-600">+</button></div>
                                        <div class="space-y-2">${(State.plan[sec]||[]).map((item, i) => `<div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg text-xs"><span>${item.name} (${item.amount}â‚¬)</span><button onclick="window.App.delPlanItem('${sec}', ${i})" class="text-red-300">Ã—</button></div>`).join('')}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = '<div class="p-10 text-center text-slate-400">Section en construction</div>';
                }
            },

            computeStats: () => {
                let sc=0, se=0, cash=0;
                // Calculations simplified for reliability
                State.transactions.forEach(t => {
                    const amt = parseFloat(t.amount||0);
                    if(t.type==='initial') {
                        if(t.category.includes('Ã‰pargne')) se+=amt; else if(t.category.includes('EspÃ¨ces')) cash+=amt; else sc+=amt;
                    } else if(t.type==='revenu') sc+=amt;
                    else if(t.type==='epargne') { sc-=amt; se+=amt; }
                    else if(t.type==='virement') { /* logic skipped for brevity */ }
                    else { if(t.paymentMethod==='cash') cash-=amt; else sc-=amt; }
                });
                
                const mStats = { revenu:0, fixe:0, variable:0, epargne:0 };
                State.transactions.filter(t=>t.date.startsWith(State.currentMonth)).forEach(t => { if(mStats[t.type]!==undefined) mStats[t.type]+=parseFloat(t.amount||0); });
                
                const planRev = (State.plan.revenus||[]).reduce((s,i)=>s+parseFloat(i.amount||0),0);
                const planFix = (State.plan.fixes||[]).reduce((s,i)=>s+parseFloat(i.amount||0),0);
                const planEp = (State.plan.epargne||[]).reduce((s,i)=>s+parseFloat(i.amount||0),0);
                const budgetVar = Math.max(0, planRev - planFix - planEp);
                const resteVar = budgetVar - mStats.variable;
                const proj = sc - Math.max(0, planFix - mStats.fixe) - Math.max(0, resteVar);

                return { sc, se, cash, patrim:sc+se+cash, mStats, resteVar, budgetVar, proj };
            },

            // --- ACTIONS & MODALS ---
            openModal: (type, data) => {
                const modal = document.getElementById('modals');
                let inner = '';
                
                if (type === 'transaction') {
                    const d = data || { date: new Date().toISOString().slice(0,10), amount: '', type: 'variable', category: State.categories.variable[0] };
                    inner = `
                        <form onsubmit="event.preventDefault(); window.App.saveTx({date: this.d.value, amount: this.a.value, type: this.t.value, category: this.c.value, name: this.n.value, paymentMethod: this.p.value}, '${data?data.id:''}')">
                            <h3 class="font-bold text-lg mb-4">${data?'Modifier':'Nouvelle'} OpÃ©ration</h3>
                            <div class="flex gap-2 mb-4 bg-slate-100 p-1 rounded-xl">
                                ${['variable','fixe','revenu','epargne','virement'].map(t=>`<label class="flex-1 text-center py-2 text-[10px] uppercase font-bold cursor-pointer rounded-lg has-[:checked]:bg-white has-[:checked]:shadow transition-all"><input type="radio" name="t" value="${t}" class="hidden" ${d.type===t?'checked':''} onclick="window.App.updateCatSelect(this.value)">${t.slice(0,3)}</label>`).join('')}
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <input name="d" type="date" value="${d.date}" class="border p-3 rounded-xl w-full text-sm font-bold bg-slate-50" required>
                                <input name="a" type="number" step="0.01" value="${d.amount}" placeholder="â‚¬" class="border p-3 rounded-xl w-full text-right font-bold bg-slate-50" required>
                            </div>
                            <select id="cat-select" name="c" class="w-full border p-3 rounded-xl mb-4 bg-white text-sm">${State.categories[d.type].map(c=>`<option ${c===d.category?'selected':''}>${c}</option>`).join('')}</select>
                            <div class="flex gap-4 mb-4 text-xs font-bold text-slate-500 justify-center">
                                <label><input type="radio" name="p" value="courant" checked> Carte</label>
                                <label><input type="radio" name="p" value="cash"> Cash</label>
                            </div>
                            <input name="n" value="${d.name||''}" placeholder="Description" class="w-full border p-3 rounded-xl mb-6 text-sm">
                            <button class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Valider</button>
                        </form>
                    `;
                } else if (type === 'onboarding-1') {
                     inner = `<form onsubmit="event.preventDefault(); window.App.addInitial(this.c.value, this.e.value, this.ca.value)">
                        <h3 class="font-bold text-lg mb-4">Bienvenue ! ðŸ‘‹</h3>
                        <p class="text-sm text-slate-500 mb-4">Initialisons vos soldes actuels :</p>
                        <input name="c" type="number" step="0.01" placeholder="Compte Courant" class="w-full border p-3 rounded-xl mb-3 font-bold">
                        <input name="e" type="number" step="0.01" placeholder="Ã‰pargne" class="w-full border p-3 rounded-xl mb-3 font-bold">
                        <input name="ca" type="number" step="0.01" placeholder="EspÃ¨ces" class="w-full border p-3 rounded-xl mb-6 font-bold">
                        <button class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">DÃ©marrer</button>
                    </form>`;
                } else if (type === 'plan-item') {
                    const sec = data;
                    inner = `<form onsubmit="event.preventDefault(); window.App.addPlanItem('${sec}', {name:this.n.value, amount:this.a.value, category:this.c.value})">
                        <h3 class="font-bold text-lg mb-4 capitalize">Ajouter ${sec}</h3>
                        <input name="n" placeholder="Nom (ex: Loyer)" class="w-full border p-3 rounded-xl mb-3 text-sm" required>
                        <input name="a" type="number" step="0.01" placeholder="Montant â‚¬" class="w-full border p-3 rounded-xl mb-3 font-bold" required>
                        <select name="c" class="w-full border p-3 rounded-xl mb-6 text-sm bg-white">${(State.categories[sec==='revenus'?'revenu':sec==='fixes'?'fixe':'epargne']).map(c=>`<option>${c}</option>`).join('')}</select>
                        <button class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Ajouter</button>
                    </form>`;
                }

                modal.innerHTML = `
                    <div class="fixed inset-0 bg-slate-900/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-[fadeIn_0.2s]">
                        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 relative">
                            <button onclick="document.getElementById('modals').innerHTML=''" class="absolute top-4 right-4 text-slate-400 text-xl font-bold">Ã—</button>
                            ${inner}
                        </div>
                    </div>
                `;
            },

            updateCatSelect: (type) => {
                document.getElementById('cat-select').innerHTML = State.categories[type].map(c=>`<option>${c}</option>`).join('');
            },

            saveTx: async (data, id) => {
                document.getElementById('modals').innerHTML = '';
                const col = collection(db, 'artifacts', APP_ID, 'users', State.user.uid, 'transactions');
                if(id) await updateDoc(doc(db, 'artifacts', APP_ID, 'users', State.user.uid, 'transactions', id), data);
                else await addDoc(col, { ...data, createdAt: new Date().toISOString() });
            },

            delTx: async (id) => { 
                if(confirm('Supprimer ?')) await deleteDoc(doc(db, 'artifacts', APP_ID, 'users', State.user.uid, 'transactions', id)); 
            },

            addInitial: async (c, e, ca) => {
                document.getElementById('modals').innerHTML = '';
                const batch = writeBatch(db);
                const col = collection(db, 'artifacts', APP_ID, 'users', State.user.uid, 'transactions');
                const d = new Date().toISOString().slice(0,10);
                if(c) batch.set(doc(col), { type: 'initial', amount: parseFloat(c), category: 'Compte Courant', date: d, createdAt: new Date().toISOString() });
                if(e) batch.set(doc(col), { type: 'initial', amount: parseFloat(e), category: 'Compte Ã‰pargne', date: d, createdAt: new Date().toISOString() });
                if(ca) batch.set(doc(col), { type: 'initial', amount: parseFloat(ca), category: 'EspÃ¨ces', date: d, createdAt: new Date().toISOString() });
                await batch.commit();
            },
            
            genMonthly: async () => {
                if(!confirm("GÃ©nÃ©rer les frais fixes ?")) return;
                const batch = writeBatch(db);
                const col = collection(db, 'artifacts', APP_ID, 'users', State.user.uid, 'transactions');
                (State.plan.fixes||[]).forEach(item => {
                     batch.set(doc(col), {
                        type: 'fixe', category: item.category, name: item.name, amount: parseFloat(item.amount),
                        date: `${State.month}-${String(item.day || 1).padStart(2,'0')}`, createdAt: new Date().toISOString(), paymentMethod: 'courant'
                     });
                });
                await batch.commit();
            },

            addPlanItem: async (sec, data) => {
                 document.getElementById('modals').innerHTML = '';
                 const newS = [...(State.plan[sec]||[]), data];
                 await setDoc(doc(db, 'artifacts', APP_ID, 'users', State.user.uid, 'settings', 'budget_plan'), {...State.plan, [sec]:newS});
            },
            
            delPlanItem: async (sec, idx) => {
                 const newS = [...State.plan[sec]]; newS.splice(idx,1);
                 await setDoc(doc(db, 'artifacts', APP_ID, 'users', State.user.uid, 'settings', 'budget_plan'), {...State.plan, [sec]:newS});
            }
        };

        // Bind global functions for HTML access
        window.App = App;
        window.formatMoney = formatMoney;

        // Init
        App.init();

    </script>
</body>
</html>
